<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red Force - Login</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f4f4f9; text-align: center; margin: 0; padding: 0; }
        
        /* Estilos del Hero y Header (Igual que antes) */
        .hero {
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('file:///C:/Users/Marc/Desktop/Web/Gemini_Generated_Image_fe2ouufe2ouufe2o.png');
            background-size: cover;
            background-position: top center; /* subir la imagen mostrando su parte superior */
            background-repeat: no-repeat;
            color: white;
            padding: 60px 20px;
            border-bottom: 5px solid #d9534f;
        }
        
        /* Estilos del Formulario de Login */
        .auth-container {
            background: white; max-width: 400px; margin: 40px auto; padding: 30px;
            border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        input {
            width: 90%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px;
        }
        
        .btn-auth {
            width: 100%; padding: 10px; background-color: #d9534f; color: white; border: none;
            border-radius: 5px; cursor: pointer; font-size: 1.1em; margin-top: 10px;
        }
        
        .btn-auth:hover { background-color: #c9302c; }
        
        .switch-btn {
            background: none; border: none; color: #007bff; cursor: pointer; text-decoration: underline; margin-top: 15px;
        }

        #user-info { display: none; margin-top: 20px; color: green; font-weight: bold; }
        .error { color: red; font-size: 0.9em; margin-top: 10px; }
    </style>
</head>
<body>

    <header class="hero">
        <h1>游댮 Red Force - Acceso</h1>
        <p>Inicia sesi칩n para ver tus estad칤sticas</p>
    </header>

    <div class="auth-container">
        <h2 id="form-title">Iniciar Sesi칩n</h2>
        <input type="email" id="email" placeholder="Correo electr칩nico">
        <input type="password" id="password" placeholder="Contrase침a">
        <!-- Nuevo campo: confirmar contrase침a (oculto en modo login) -->
        <input type="password" id="confirm-password" placeholder="Confirmar contrase침a" style="display:none;">
        
        <button class="btn-auth" id="action-btn" onclick="login()">Entrar</button>
        <p class="error" id="error-msg"></p>
        
        <button class="switch-btn" id="toggle-btn" onclick="toggleMode()">쯅o tienes cuenta? Reg칤strate</button>

        <div id="user-info">
            <p>춰Hola, <span id="user-email"></span>!</p>
            <button onclick="logout()" style="background: #333; color: white; padding: 5px 10px; border:none; cursor:pointer;">Cerrar Sesi칩n</button>
        </div>
    </div>

    <script type="module">
        // Importar las funciones necesarias (CDN para navegador)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        // A침adimos Firestore para guardar datos de usuario
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ------------------ Snippet solicitado (comentado para referencia) ------------------
        // Import the functions you need from the SDKs you need
        // import { initializeApp } from "firebase/app";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
        //
        // Your web app's Firebase configuration
        // const firebaseConfig = {
        //   apiKey: "AIzaSyBIH5Yf9yhB2bWFOEyqfXsbA7LAeWVo_5E",
        //   authDomain: "red-force-web.firebaseapp.com",
        //   projectId: "red-force-web",
        //   storageBucket: "red-force-web.firebasestorage.app",
        //   messagingSenderId: "581871532266",
        //   appId: "1:581871532266:web:3629362913b9ba1bc03f93"
        // };
        //
        // Initialize Firebase
        // const app = initializeApp(firebaseConfig);
        // ------------------------------------------------------------------------------------

        // Configuraci칩n real usada (la misma que en el snippet)
        const firebaseConfig = {
            apiKey: "AIzaSyBIH5Yf9yhB2bWFOEyqfXsbA7LAeWVo_5E",
            authDomain: "red-force-web.firebaseapp.com",
            projectId: "red-force-web",
            storageBucket: "red-force-web.firebasestorage.app",
            messagingSenderId: "581871532266",
            appId: "1:581871532266:web:3629362913b9ba1bc03f93"
        };

        // Inicializar Firebase y servicios
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
 
         // Variables del DOM
         const emailInput = document.getElementById('email');
         const passInput = document.getElementById('password');
         const errorMsg = document.getElementById('error-msg');
         const title = document.getElementById('form-title');
         const btn = document.getElementById('action-btn');
         const confirmInput = document.getElementById('confirm-password'); // nuevo
         const toggle = document.getElementById('toggle-btn');
         const userInfo = document.getElementById('user-info');
         const userEmailSpan = document.getElementById('user-email');
 
         let isLoginMode = true;
 
         // Si la URL contiene ?mode=register o ?mode=login, ajustar el modo inicial
         (function applyModeFromQuery() {
             try {
                 const params = new URLSearchParams(window.location.search);
                 const mode = params.get('mode');
                 if (mode === 'register' && isLoginMode) {
                     // llamar a toggleMode para cambiar a registro y actualizar UI
                     // toggleMode est치 definido m치s abajo, as칤 que comprobamos y llamamos despu칠s
                     // Usamos setTimeout 0 para ejecutar despu칠s de que toggleMode exista
                     setTimeout(() => { if (typeof toggleMode === 'function') toggleMode(); }, 0);
                 } else if (mode === 'login' && !isLoginMode) {
                     setTimeout(() => { if (typeof toggleMode === 'function') toggleMode(); }, 0);
                 }
             } catch (e) {
                 // no hacer nada si falla el parseo
                 console.error('Error leyendo mode desde la URL:', e);
             }
         })();
 
         // Funci칩n para cambiar entre Login y Registro
         window.toggleMode = function() {
             isLoginMode = !isLoginMode;
             if (isLoginMode) {
                 title.innerText = "Iniciar Sesi칩n";
                 btn.innerText = "Entrar";
                 toggle.innerText = "쯅o tienes cuenta? Reg칤strate";
                 // ocultar confirmaci칩n de contrase침a en login
                 confirmInput.style.display = 'none';
             } else {
                 title.innerText = "Registrarse";
                 btn.innerText = "Crear Cuenta";
                 toggle.innerText = "쯏a tienes cuenta? Inicia Sesi칩n";
                 // mostrar confirmaci칩n de contrase침a en registro
                 confirmInput.style.display = 'inline-block';
             }
             errorMsg.innerText = "";
         }
 
         // Funci칩n principal de Login/Registro
         window.login = function() {
             const email = emailInput.value;
             const password = passInput.value;
             const confirmPassword = confirmInput.value;
             errorMsg.innerText = "";
 
             if (isLoginMode) {
                 // INICIAR SESI칍N
                 signInWithEmailAndPassword(auth, email, password)
                     .then((userCredential) => {
                         // Redirigir a la p치gina principal al iniciar sesi칩n
                         window.location.href = 'P치gina_principal.html';
                     })
                     .catch((error) => {
                         // Mostrar mensaje personalizado si la cuenta no existe
                         if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                             errorMsg.innerText = "No teienes cuenta, registrate.";
                         } else {
                             errorMsg.innerText = "Error: " + error.message;
                         }
                     });
             } else {
                 // REGISTRARSE
                 // Validar que las contrase침as coincidan
                 if (!password || password !== confirmPassword) {
                     errorMsg.innerText = "Las contrase침as no coinciden.";
                     return;
                 }
                 createUserWithEmailAndPassword(auth, email, password)
                     .then(async (userCredential) => {
                        // Guardar datos b치sicos del usuario en Firestore
                        try {
                            await setDoc(doc(db, 'users', userCredential.user.uid), {
                                email: userCredential.user.email,
                                createdAt: serverTimestamp()
                            });
                            console.log("Registrado y datos guardados en la DB.");
                            // Redirigir a la p치gina principal tras registro
                            window.location.href = 'P치gina_principal.html';
                        } catch (e) {
                            console.error("Error guardando en DB: ", e);
                        }
                     })
                     .catch((error) => {
                         errorMsg.innerText = "Error: " + error.message;
                     });
             }
         }
 
         // Funci칩n de Cerrar Sesi칩n
         window.logout = function() {
             signOut(auth).then(() => {
                 console.log("Sesi칩n cerrada");
             });
         }
 
         // Escuchar cambios de estado (si el usuario entra o sale)
         onAuthStateChanged(auth, (user) => {
             if (user) {
                // Si estamos en la p치gina de autenticaci칩n, redirigir al principal
                try {
                    const current = window.location.pathname + window.location.search;
                    if (current.includes('Iniciar sesi칩n y Registrarse.html') || current.toLowerCase().includes('iniciar')) {
                        // usar encodeURI por el nombre con acentos
                        window.location.href = encodeURI('P치gina_principal.html');
                        return;
                    }
                } catch (e) {
                    console.error('Redirect check failed:', e);
                }

                // Usuario conectado (si no se redirigi칩)
                userInfo.style.display = "block";
                userEmailSpan.innerText = user.email;
                
                // Ocultar inputs
                emailInput.style.display = 'none';
                passInput.style.display = 'none';
                confirmInput.style.display = 'none';
                btn.style.display = 'none';
                toggle.style.display = 'none';
                title.innerText = "Bienvenido al Panel";
             } else {
                 // Usuario desconectado
                 userInfo.style.display = "none";
                
                 // Mostrar inputs
                 emailInput.style.display = 'inline-block';
                 passInput.style.display = 'inline-block';
                 // mostrar/ocultar confirm seg칰n modo actual
                 confirmInput.style.display = isLoginMode ? 'none' : 'inline-block';
                 btn.style.display = 'inline-block';
                 toggle.style.display = 'inline-block';
                 title.innerText = isLoginMode ? "Iniciar Sesi칩n" : "Registrarse";
             }
         });
     </script>
</body>
</html>